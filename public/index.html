<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EduTalk — Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css?v=5" />
</head>
<body>
  <header class="nav">
    <h1><a href="/" style="color:inherit;text-decoration:none">EduTalk VideoShare</a></h1>
    <nav>
      <a href="/.auth/login/aad">Sign in</a>
      <a href="/.auth/logout">Sign out</a>
      <a href="/videos.html">All Videos</a>
      <a href="/upload.html">Upload</a>
    </nav>
  </header>

  <main class="container">
    <section class="hero card">
      <h2 style="margin:0 0 8px">Welcome to EduTalk</h2>
      <p class="muted" style="margin:0">
        Browse the latest educational videos. Creators can upload with title, publisher, producer, genre, and age rating.
      </p>
      <div style="margin-top:12px;display:flex;gap:10px">
        <a class="btn" href="/videos.html">Browse All</a>
        <a class="btn btn-outline" href="/upload.html">Upload</a>
      </div>
    </section>

    <section class="card">
      <h2 style="margin-top:0">Latest videos</h2>
      <div id="latest" class="grid-cards"></div>
      <p id="latestStatus" class="muted"></p>
    </section>
  </main>

  <footer class="footer">© EduTalk</footer>

  <script>
    // ---------- helpers ----------
    const esc = (s='') => String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#39;');

    function ytId(url=''){
      try{
        const u = new URL(url);
        if (u.hostname.includes('youtu.be')) return u.pathname.slice(1);
        if (u.hostname.includes('youtube.com')){
          if (u.searchParams.get('v')) return u.searchParams.get('v');
          const p = u.pathname.split('/'); const i = p.indexOf('embed');
          if (i !== -1 && p[i+1]) return p[i+1];
        }
      }catch{}
      return null;
    }

    function ytEmbed(id){
      const src = `https://www.youtube.com/embed/${id}?rel=0&modestbranding=1&playsinline=1`;
      return `<iframe class="player" src="${src}" title="YouTube player" frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe>`;
    }

    // ---------- render latest grid ----------
    function renderLatest(items){
      const box = document.getElementById('latest');
      const status = document.getElementById('latestStatus');

      const latest = (Array.isArray(items)?items:[])
        .slice()
        .sort((a,b)=>new Date(b.createdAt||0)-new Date(a.createdAt||0))
        .slice(0,6);

      if (!latest.length){
        status.textContent = 'No videos yet.';
        box.innerHTML = '';
        return;
      }

      status.textContent = '';
      box.innerHTML = latest.map(v=>{
        const id = ytId(v.playbackUrl||'');
        const player = id
          ? ytEmbed(id)
          : (v.playbackUrl
              ? `<video class="player" src="${esc(v.playbackUrl)}" controls preload="metadata"></video>`
              : '');

        return `<article class="card">
          ${player}
          <h3 style="margin:8px 0 4px">${esc(v.title || 'Untitled')}</h3>
          <p class="muted" style="margin:0">${esc(v.publisher || '')}</p>
        </article>`;
      }).join('');
    }

    // ---------- load latest ----------
    (async ()=>{
      const status = document.getElementById('latestStatus');
      try{
        const res = await fetch('/videos?ts=' + Date.now(), {
          headers: { 'Accept':'application/json', 'Cache-Control':'no-cache' }
        });
        const txt = await res.text();
        if (!res.ok){ status.textContent = `HTTP ${res.status}: ${txt.slice(0,160)}`; return; }
        let data; try { data = JSON.parse(txt); } catch { status.textContent = 'Invalid JSON'; return; }
        renderLatest(data);
      }catch(e){
        status.textContent = 'Could not load latest videos: ' + e.message;
        console.error(e);
      }
    })();
  </script>
</body>
</html>
