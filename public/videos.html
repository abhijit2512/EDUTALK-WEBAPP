<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Uploaded Videos — EduTalk</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css?v=4" />
</head>
<body>
  <header class="nav">
    <h1><a href="/" style="color:inherit;text-decoration:none">EduTalk VideoShare</a></h1>
    <nav>
      <a href="/.auth/login/aad">Sign in</a>
      <a href="/.auth/logout">Sign out</a>
      <a href="/videos.html">All Videos</a>
      <a href="/upload.html">Upload</a>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <h2 style="margin:0">Uploaded Videos</h2>
      <p id="status" class="muted" style="margin:8px 0 12px">Loading…</p>
      <div id="list" class="grid-cards"></div>
    </section>
  </main>

  <footer class="footer">© EduTalk</footer>

  <script>
    // ---------- API Base URL (your backend) ----------
    const API_BASE = "https://apivideoshare-d5exf9a9fmhvbjef.canadacentral-01.azurewebsites.net";

    // ---------- helpers ----------
    function esc(s=''){return String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#39;');}
    function ytid(url=''){try{
      const u=new URL(url);
      if(u.hostname.includes('youtu.be')) return u.pathname.slice(1);
      if(u.hostname.includes('youtube.com')){
        if(u.searchParams.get('v')) return u.searchParams.get('v');
        const p=u.pathname.split('/'); const i=p.indexOf('embed'); if(i!==-1 && p[i+1]) return p[i+1];
      }}catch{} return null;}
    const ythumb = id => `https://i.ytimg.com/vi/${id}/hqdefault.jpg`;

    function renderGrid(items){
      const list = document.getElementById('list');
      const data = (Array.isArray(items) ? items : []).slice()
        .sort((a,b)=>new Date(b.createdAt||0)-new Date(a.createdAt||0));
      if (!data.length){
        list.innerHTML = '<p class="muted">No videos found.</p>';
        return;
      }
      list.innerHTML = data.map(v=>{
        const id = ytid(v.playbackUrl||'');
        const player = id
          ? `<div class="thumb" style="background-image:url('${ythumb(id)}')"
               onclick="window.open('https://www.youtube.com/watch?v=${id}','_blank')">
               <div class="play"></div></div>`
          : (v.playbackUrl
              ? `<video class="player" src="${esc(v.playbackUrl)}" controls preload="metadata"></video>`
              : `<div class="player" style="display:flex;align-items:center;justify-content:center;background:#0a0f20;color:#9aa3b2">No preview</div>`);
        const meta = [
          v.publisher && 'Publisher: '+esc(v.publisher),
          v.producer  && 'Producer: '+esc(v.producer),
          v.genre     && 'Genre: '+esc(v.genre),
          v.age       && 'Age: '+esc(v.age)
        ].filter(Boolean).join(' | ');
        return `<article class="card">
          <h3 style="margin:0 0 6px">${esc(v.title||'Untitled')}</h3>
          <p class="muted" style="margin:0 0 8px">${meta || '&nbsp;'}</p>
          ${player}
        </article>`;
      }).join('');
    }

    // ---------- loader ----------
    (async () => {
      const statusEl = document.getElementById('status');
      try {
        const res = await fetch(`${API_BASE}/videos?nocache=` + Date.now(), {
          headers: { 'Accept':'application/json', 'Cache-Control':'no-cache' }
        });
        const raw = await res.text();
        if (!res.ok) {
          statusEl.textContent = `HTTP ${res.status}. Body: ${raw.slice(0,160).replace(/\s+/g,' ')}`;
          console.error('[videos] HTTP', res.status, raw);
          return;
        }
        let data;
        try { data = JSON.parse(raw); }
        catch { 
          statusEl.textContent = `HTTP 200, but response is not JSON. Body: ${raw.slice(0,160).replace(/\s+/g,' ')}`;
          console.error('[videos] Non-JSON body:', raw);
          return;
        }
        statusEl.textContent = `Found ${Array.isArray(data) ? data.length : 0} video(s).`;
        renderGrid(data);
      } catch (err) {
        statusEl.textContent = 'Fetch error: ' + err.message;
        console.error('[videos] fetch error', err);
      }
    })();
  </script>
</body>
</html>
