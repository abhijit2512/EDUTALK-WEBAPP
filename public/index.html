<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EduTalk — Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- v3: force redeploy -->
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <header class="nav">
    <h1><a href="/" style="color:inherit;text-decoration:none">EduTalk VideoShare</a></h1>
    <nav>
      <!-- Auth links (Azure Easy Auth) -->
      <a href="/.auth/login/aad">Sign in</a>
      <a href="/.auth/logout">Sign out</a>
      <!-- Absolute links so we never end up under /.auth/... -->
      <a href="/videos.html">All Videos</a>
      <a href="/upload.html">Upload</a>
    </nav>
  </header>

  <main class="container">
    <section class="hero card">
      <h2 style="margin:0 0 8px 0">Welcome to EduTalk</h2>
      <p class="muted" style="margin:0">
        Browse the latest educational videos. Creators can upload with title, publisher, producer, genre, and age rating.
      </p>
      <div class="cta" style="margin-top:12px">
        <a class="btn" href="/videos.html">Browse All</a>
        <a class="btn btn-outline" href="/upload.html">Upload</a>
      </div>
    </section>

    <!-- Dashboard: Latest videos -->
    <section class="card">
      <h2 style="margin-top:0">Latest videos</h2>
      <div id="latest" class="grid-cards"></div>
    </section>
  </main>

  <footer class="footer">© EduTalk</footer>

  <script>
    // ----- helpers -----
    function api(path, opts = {}) {
      const url = path.startsWith('/') ? path : '/' + path;
      const headers = Object.assign({}, opts.headers || {}, opts.json ? {'Content-Type':'application/json'} : {});
      const body = opts.json ? JSON.stringify(opts.json) : opts.body;
      return fetch(url, { method: opts.method || 'GET', headers, body });
    }
    function escapeHtml(s=''){return String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#39;');}
    function extractYouTubeId(url=''){try{
      const u=new URL(url);
      if(u.hostname.includes('youtu.be')) return u.pathname.slice(1);
      if(u.hostname.includes('youtube.com')){
        if(u.searchParams.get('v')) return u.searchParams.get('v');
        const p=u.pathname.split('/'); const i=p.indexOf('embed'); if(i!==-1&&p[i+1]) return p[i+1];
      }
    }catch{} return null;}
    function ytThumb(id){ return `https://i.ytimg.com/vi/${id}/hqdefault.jpg`; }

    // ----- render latest -----
    async function loadLatest(){
      const box = document.getElementById('latest');
      try{
        const res = await api('/videos'); // backend returns an ARRAY
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const all = await res.json();

        const latest = (all||[])
          .sort((a,b)=>new Date(b.createdAt||0)-new Date(a.createdAt||0))
          .slice(0,6);

        box.innerHTML = latest.map(v=>{
          const yt = extractYouTubeId(v.playbackUrl||'');
          const player = yt
            ? `<div class="thumb" style="background-image:url('${ytThumb(yt)}')"
                 onclick="window.open('https://www.youtube.com/watch?v=${yt}','_blank')">
                 <div class="play"></div></div>`
            : `<video class="player" src="${v.playbackUrl||''}" controls preload="metadata"></video>`;

          return `
            <article class="card">
              ${player}
              <div class="meta">
                <h3>${escapeHtml(v.title||'Untitled')}</h3>
                <p class="muted">
                  ${escapeHtml(v.publisher||'')} ${v.genre ? ' • '+escapeHtml(v.genre) : ''} ${v.age ? ' • '+escapeHtml(v.age) : ''}
                </p>
              </div>
            </article>`;
        }).join('');
      }catch(e){
        box.innerHTML = '<p class="muted">Could not load latest videos.</p>';
        console.error(e);
      }
    }
    loadLatest();
  </script>
</body>
</html>
