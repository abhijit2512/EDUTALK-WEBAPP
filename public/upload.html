<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EduTalk — Upload</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css?v=8" />
  <style>
    .muted{color:#9aa3b2}
    .field{display:grid;gap:6px;margin:10px 0}
    .field input{padding:8px 10px;border:1px solid #20314f;background:#0a0f20;color:#e8eefc;border-radius:8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 12px;background:#1a3a8a;color:#fff;border:none;border-radius:8px;cursor:pointer}
    .btn.secondary{background:#253a6b}
    .btn.danger{background:#8a1a1a}
    .badge{font-size:12px;padding:2px 8px;background:#13213b;color:#a9b6d3;border-radius:999px}
    .card h2{margin:0 0 8px}
  </style>
</head>
<body>
<header class="nav">
  <h1><a href="/" style="color:inherit;text-decoration:none">EduTalk VideoShare</a></h1>
  <nav style="display:flex;gap:10px;align-items:center">
    <span class="badge" id="roleBadge">Guest</span>
    <button id="btnRole"  class="btn secondary" type="button" style="display:none" title="Switch between Consumer and Creator">Switch Role</button>
    <button id="btnSignIn"  class="btn"          type="button">Sign in</button>
    <button id="btnSignOut" class="btn danger"   type="button" style="display:none">Sign out</button>
    <a href="/videos.html">All Videos</a>
  </nav>
</header>

<main class="container">
  <section class="card">
    <h2>Upload a New Video</h2>

    <!-- Only-Creator message -->
    <div id="gateMsg" class="muted" style="display:none">
      You must be signed in as <b>Creator</b> to upload. Use “Sign in”, then “Switch Role” to become a Creator.
    </div>

    <!-- Creator-only form -->
    <form id="formWrap" style="display:none;max-width:560px">
      <div class="field">
        <label>Title</label>
        <input id="title" placeholder="e.g., Algebra Basics" />
      </div>
      <div class="row">
        <div class="field" style="flex:1 1 230px">
          <label>Publisher</label>
          <input id="publisher" placeholder="Publisher" />
        </div>
        <div class="field" style="flex:1 1 230px">
          <label>Producer</label>
          <input id="producer"  placeholder="Producer" />
        </div>
      </div>
      <div class="row">
        <div class="field" style="flex:1 1 230px">
          <label>Genre</label>
          <input id="genre"     placeholder="e.g., edtalk" />
        </div>
        <div class="field" style="flex:1 1 230px">
          <label>Age Rating</label>
          <input id="age"       placeholder="e.g., 13+" />
        </div>
      </div>

      <!-- Keep it simple: just paste the final playback URL (YouTube link or MP4 URL) -->
      <div class="field">
        <label>Playback URL (YouTube link or direct MP4/WebM/Ogg URL)</label>
        <input id="playbackUrl" placeholder="https://... (YouTube or blob URL)" />
      </div>

      <div class="row">
        <button class="btn" id="btnSubmit" type="submit">Upload</button>
        <span id="status" class="muted"></span>
      </div>
    </form>
  </section>
</main>

<footer class="footer">© EduTalk</footer>

<!-- MSAL -->
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
<script>
  // ===== Auth & Role (same IDs you used on videos.html) =====
  const TENANT_ID = "b0e4c77a-c53c-4cbc-8f97-72baebc755dd";
  const CLIENT_ID = "7eaa59ec-154f-4bd9-8abd-fd453b0b1d76";

  const msalInstance = new msal.PublicClientApplication({
    auth:{ clientId: CLIENT_ID, authority:`https://login.microsoftonline.com/${TENANT_ID}`, redirectUri: window.location.origin },
    cache:{ cacheLocation:"localStorage" }
  });

  let ID_TOKEN = localStorage.getItem("EDUTALK_ID_TOKEN") || null;
  let ME = null; // {oid,email,name,role}

  function authz(extra={}) {
    const t = ID_TOKEN || localStorage.getItem("EDUTALK_ID_TOKEN") || "";
    return t ? { ...extra, Authorization:`Bearer ${t}` } : extra;
  }

  async function signIn(){
    try{
      const login = await msalInstance.loginPopup({ scopes:["openid","profile","email"] });
      const token = await msalInstance.acquireTokenSilent({ account: login.account, scopes:["openid","profile","email"]});
      ID_TOKEN = token.idToken;
      localStorage.setItem("EDUTALK_ID_TOKEN", ID_TOKEN);
      await refreshMe(); renderAuthUI(); gateUI();
    }catch(e){ alert("Sign in failed: "+(e.message||e)); }
  }
  async function signOut(){
    localStorage.removeItem("EDUTALK_ID_TOKEN"); ID_TOKEN=null; ME=null;
    try{ await msalInstance.logoutPopup(); }catch{}
    renderAuthUI(); gateUI();
  }

  async function refreshMe(){
    try{
      const res = await fetch("/me",{ headers: authz({Accept:"application/json"})});
      ME = res.ok ? (await res.json()).user : null;
    }catch{ ME=null; }
    updateRoleBadge();
  }

  function updateRoleBadge(){
    const b = document.getElementById("roleBadge");
    b.textContent = ME ? ME.role : "Guest";
    const btnRole = document.getElementById("btnRole");
    btnRole.style.display = ME ? "inline-flex" : "none";
    btnRole.textContent = ME && ME.role==="Creator" ? "Switch to Consumer" : "Switch to Creator";
  }

  async function switchRole(){
    if(!ME) return alert("Please sign in first.");
    const target = ME.role==="Creator" ? "Consumer" : "Creator";
    const res = await fetch("/me/role",{ method:"POST", headers: authz({"Content-Type":"application/json"}), body: JSON.stringify({role:target}) });
    if(!res.ok){ return alert("Role change failed: "+(await res.text()).slice(0,200)); }
    await refreshMe(); gateUI();
  }

  function renderAuthUI(){
    const signed = !!(ID_TOKEN || localStorage.getItem("EDUTALK_ID_TOKEN"));
    document.getElementById("btnSignIn").style.display  = signed ? "none" : "inline-flex";
    document.getElementById("btnSignOut").style.display = signed ? "inline-flex" : "none";
    updateRoleBadge();
  }

  function gateUI(){
    const isCreator = !!(ME && ME.role==="Creator");
    document.getElementById("formWrap").style.display = isCreator ? "block" : "none";
    document.getElementById("gateMsg").style.display  = isCreator ? "none"  : "block";
  }

  // ===== Upload (Creator only) =====
  async function submitForm(e){
    e.preventDefault();
    const status = document.getElementById("status");
    status.textContent = "";

    if(!ME || ME.role!=="Creator"){
      status.textContent = "You must be Creator to upload.";
      return;
    }
    const body = {
      title:       document.getElementById("title").value.trim(),
      publisher:   document.getElementById("publisher").value.trim(),
      producer:    document.getElementById("producer").value.trim(),
      genre:       document.getElementById("genre").value.trim(),
      age:         document.getElementById("age").value.trim(),
      playbackUrl: document.getElementById("playbackUrl").value.trim(),
      external:    true
    };
    if(!body.title || !body.playbackUrl){
      status.textContent = "Title and Playback URL are required.";
      return;
    }

    try{
      document.getElementById("btnSubmit").disabled = true;
      status.textContent = "Uploading…";
      const res = await fetch("/videos",{
        method:"POST",
        headers: { ...authz({"Content-Type":"application/json"}) },
        body: JSON.stringify(body)
      });
      const txt = await res.text();
      if(!res.ok){
        status.textContent = `Upload failed: ${res.status} ${res.statusText} — ${(txt||"").slice(0,180)}`;
        return;
      }
      status.textContent = "Uploaded ✓";
      // optional: redirect to videos
      // window.location.href = "/videos.html";
    }catch(e){
      status.textContent = "Upload error: "+e.message;
    }finally{
      document.getElementById("btnSubmit").disabled = false;
    }
  }

  // ===== Bootstrap =====
  (async ()=>{
    renderAuthUI();
    if(ID_TOKEN) await refreshMe();
    gateUI();

    document.getElementById("btnSignIn").addEventListener("click", signIn);
    document.getElementById("btnSignOut").addEventListener("click", signOut);
    document.getElementById("btnRole").addEventListener("click", switchRole);
    document.getElementById("formWrap").addEventListener("submit", submitForm);
  })();
</script>
</body>
</html>
