<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EduTalk — Upload</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css?v=8" />
  <style>
    .muted { color:#9aa3b2 }
    .only-creator { display:none }
  </style>
</head>
<body>
<header class="nav">
  <h1><a href="/" style="color:inherit;text-decoration:none">EduTalk VideoShare</a></h1>
  <nav style="display:flex;gap:10px;align-items:center">
    <span id="roleBadge" class="badge">Guest</span>
    <button id="btnSignIn" class="btn" type="button">Sign in</button>
    <button id="btnSignOut" class="btn danger" type="button" style="display:none">Sign out</button>
    <a href="/videos.html">All Videos</a>
  </nav>
</header>

<main class="container">
  <section class="card">
    <h2 style="margin:0">Upload a New Video</h2>
    <p id="gateMsg" class="muted"></p>

    <form id="form" class="only-creator">
      <div style="display:grid;gap:10px;max-width:420px">
        <label>Title:<br><input id="title" required /></label>
        <label>Publisher:<br><input id="publisher" /></label>
        <label>Producer:<br><input id="producer" /></label>
        <label>Genre:<br><input id="genre" /></label>
        <label>Age Rating:<br><input id="age" value="PG" /></label>

        <!-- If you already upload to Blob and get a URL, keep using it.
             This page just posts that URL to /videos with auth -->
        <label>Playback URL:<br><input id="playbackUrl" placeholder="https://...mp4 or YouTube link" required /></label>

        <div style="display:flex;gap:10px;align-items:center">
          <button id="btnUpload" class="btn" type="submit">Upload</button>
          <span id="status" class="muted"></span>
        </div>
      </div>
    </form>
  </section>
</main>

<footer class="footer">© EduTalk</footer>

<!-- MSAL -->
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
<script>
/* ---------- AUTH (same IDs as videos.html) ---------- */
const TENANT_ID = "b0e4c77a-c53c-4cbc-8f97-72baebc755dd";
const CLIENT_ID = "7eaa59ec-154f-4bd9-8abd-fd453b0b1d76";

const msalInstance = new msal.PublicClientApplication({
  auth: { clientId: CLIENT_ID, authority: `https://login.microsoftonline.com/${TENANT_ID}`, redirectUri: window.location.origin },
  cache: { cacheLocation: "localStorage" }
});

let ID_TOKEN = localStorage.getItem("EDUTALK_ID_TOKEN") || null;
let ME = null; // {role,...}

function authz(h={}){ return ID_TOKEN ? { ...h, Authorization:`Bearer ${ID_TOKEN}` } : h; }

async function signIn(){
  const login = await msalInstance.loginPopup({ scopes:["openid","profile","email"] });
  const token = await msalInstance.acquireTokenSilent({ account: login.account, scopes:["openid","profile","email"] });
  ID_TOKEN = token.idToken;
  localStorage.setItem("EDUTALK_ID_TOKEN", ID_TOKEN);
  await refreshMe();
  renderAuth();
}

async function signOut(){
  localStorage.removeItem("EDUTALK_ID_TOKEN");
  ID_TOKEN = null; ME = null;
  try{ await msalInstance.logoutPopup(); }catch{}
  renderAuth();
}

async function refreshMe(){
  try{
    const res = await fetch("/me", { headers: authz({Accept:"application/json"}) });
    ME = res.ok ? (await res.json()).user : null;
  }catch{ ME = null; }
}

function renderAuth(){
  const signed = !!ID_TOKEN && !!ME;
  document.getElementById("btnSignIn").style.display = signed ? "none" : "inline-flex";
  document.getElementById("btnSignOut").style.display = signed ? "inline-flex" : "none";
  document.getElementById("roleBadge").textContent = ME ? ME.role : "Guest";

  const gate = document.getElementById("gateMsg");
  const form = document.getElementById("form");
  const isCreator = !!ME && ME.role === "Creator";
  form.style.display = isCreator ? "" : "none";
  gate.textContent = isCreator
    ? ""
    : "Sign in as a Creator to upload. (Videos page → Switch to Creator)";
}

/* ---------- FORM POST ---------- */
function val(id){ return (document.getElementById(id).value || "").trim(); }

async function handleSubmit(e){
  e.preventDefault();
  const status = document.getElementById("status");
  if (!ME){ alert("Please sign in."); return; }
  if (ME.role !== "Creator"){ alert("Only Creators can upload."); return; }

  const body = {
    title: val("title"),
    publisher: val("publisher"),
    producer: val("producer"),
    genre: val("genre"),
    age: val("age"),
    playbackUrl: val("playbackUrl"),
    external: true
  };
  if (!body.title || !body.playbackUrl){ alert("Title and Playback URL are required."); return; }

  try{
    status.textContent = "Uploading…";
    const res = await fetch("/videos", {
      method:"POST",
      headers: authz({ "Content-Type":"application/json", Accept:"application/json" }),
      body: JSON.stringify(body)
    });
    const txt = await res.text();
    if (!res.ok){ throw new Error(txt); }
    status.textContent = "Uploaded ✔";
    // Optionally jump back to list
    // location.href = "/videos.html";
  }catch(err){
    status.textContent = "Upload failed";
    alert("Upload failed: " + (err.message || err));
  }
}

/* ---------- BOOT ---------- */
(async () => {
  try{
    // if a token exists, try using it
    if (ID_TOKEN){ await refreshMe(); }
  }finally{
    renderAuth();
  }
  document.getElementById("btnSignIn").addEventListener("click", signIn);
  document.getElementById("btnSignOut").addEventListener("click", signOut);
  document.getElementById("form").addEventListener("submit", handleSubmit);
})();
</script>
</body>
</html>
