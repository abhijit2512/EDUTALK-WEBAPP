<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EduTalk — Upload</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css?v=9" />

  <!-- OPTIONAL: Put your Azure Blob *Container SAS URL* here to enable desktop uploads.
       Example: https://stvideosedutalk.blob.core.windows.net/videos?<SAS>
       Leave empty to hide the desktop file UI. -->
  <meta name="blob-container-sas" content="PUT_YOUR_CONTAINER_SAS_URL_HERE" />

  <style>
    .muted{color:#9aa3b2}
    .field{display:grid;gap:6px;margin:10px 0}
    .field input{padding:8px 10px;border:1px solid #20314f;background:#0a0f20;color:#e8eefc;border-radius:8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 12px;background:#1a3a8a;color:#fff;border:none;border-radius:8px;cursor:pointer}
    .btn.secondary{background:#253a6b}
    .btn.danger{background:#8a1a1a}
    .badge{font-size:12px;padding:2px 8px;background:#13213b;color:#a9b6d3;border-radius:999px}
    .card h2{margin:0 0 8px}
    .small{font-size:12px}
    .pill{padding:2px 8px;border-radius:999px;border:1px dashed #20314f}
  </style>
</head>
<body>
<header class="nav">
  <h1><a href="/" style="color:inherit;text-decoration:none">EduTalk VideoShare</a></h1>
  <nav style="display:flex;gap:10px;align-items:center">
    <span class="badge" id="roleBadge">Guest</span>
    <button id="btnRole"  class="btn secondary" type="button" style="display:none" title="Switch between Consumer and Creator">Switch Role</button>
    <button id="btnSignIn"  class="btn"          type="button">Sign in</button>
    <button id="btnSignOut" class="btn danger"   type="button" style="display:none">Sign out</button>
    <a href="/videos.html">All Videos</a>
  </nav>
</header>

<main class="container">
  <section class="card">
    <h2>Upload a New Video</h2>

    <!-- Only-Creator message -->
    <div id="gateMsg" class="muted" style="display:none">
      You must be signed in as <b>Creator</b> to upload. Use “Sign in”, then “Switch Role” to become a Creator.
    </div>

    <!-- Creator-only form -->
    <form id="formWrap" style="display:none;max-width:680px">
      <div class="field">
        <label>Title</label>
        <input id="title" placeholder="e.g., Algebra Basics" />
      </div>
      <div class="row">
        <div class="field" style="flex:1 1 230px">
          <label>Publisher</label>
          <input id="publisher" placeholder="Publisher" />
        </div>
        <div class="field" style="flex:1 1 230px">
          <label>Producer</label>
          <input id="producer"  placeholder="Producer" />
        </div>
      </div>
      <div class="row">
        <div class="field" style="flex:1 1 230px">
          <label>Genre</label>
          <input id="genre"     placeholder="e.g., edtalk" />
        </div>
        <div class="field" style="flex:1 1 230px">
          <label>Age Rating</label>
          <input id="age"       placeholder="e.g., 13+" />
        </div>
      </div>

      <!-- (A) Paste final playback URL (works for YouTube or public blob URLs) -->
      <div class="field">
        <label>Playback URL (YouTube link or direct MP4/WebM/Ogg URL)</label>
        <input id="playbackUrl" placeholder="https://... (YouTube or blob URL)" />
      </div>

      <!-- (B) OPTIONAL desktop upload to Azure Blob (shown only if container SAS is provided) -->
      <div id="blobArea" class="field" style="display:none">
        <label>Upload from Desktop <span class="pill small">Azure Blob</span></label>
        <div class="row">
          <input id="filePick" type="file" accept="video/mp4,video/webm,video/ogg" />
          <button id="btnBlobUpload" class="btn" type="button">Upload Video File</button>
          <span id="blobStatus" class="muted small"></span>
        </div>
        <div class="small muted">
          After upload, the <b>Playback URL</b> will be filled automatically. (Your container must allow public read, which you already set to <i>Blob (anonymous read)</i>.)
        </div>
      </div>

      <div class="row" style="margin-top:6px">
        <button class="btn" id="btnSubmit" type="submit">Save to EduTalk</button>
        <span id="status" class="muted"></span>
      </div>
    </form>
  </section>
</main>

<footer class="footer">© EduTalk</footer>

<!-- MSAL -->
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
<script>
  // ===== Auth & Role (same IDs you used on videos.html) =====
  const TENANT_ID = "b0e4c77a-c53c-4cbc-8f97-72baebc755dd";
  const CLIENT_ID = "7eaa59ec-154f-4bd9-8abd-fd453b0b1d76";

  const msalInstance = new msal.PublicClientApplication({
    auth:{ clientId: CLIENT_ID, authority:`https://login.microsoftonline.com/${TENANT_ID}`, redirectUri: window.location.origin },
    cache:{ cacheLocation:"localStorage" }
  });

  let ID_TOKEN = localStorage.getItem("EDUTALK_ID_TOKEN") || null;
  let ME = null; // {oid,email,name,role}

  function authz(extra={}) {
    const t = ID_TOKEN || localStorage.getItem("EDUTALK_ID_TOKEN") || "";
    return t ? { ...extra, Authorization:`Bearer ${t}` } : extra;
  }

  async function signIn(){
    try{
      const login = await msalInstance.loginPopup({ scopes:["openid","profile","email"] });
      const token = await msalInstance.acquireTokenSilent({ account: login.account, scopes:["openid","profile","email"]});
      ID_TOKEN = token.idToken;
      localStorage.setItem("EDUTALK_ID_TOKEN", ID_TOKEN);
      await refreshMe(); renderAuthUI(); gateUI();
    }catch(e){ alert("Sign in failed: "+(e.message||e)); }
  }
  async function signOut(){
    localStorage.removeItem("EDUTALK_ID_TOKEN"); ID_TOKEN=null; ME=null;
    try{ await msalInstance.logoutPopup(); }catch{}
    renderAuthUI(); gateUI();
  }

  async function refreshMe(){
    try{
      const res = await fetch("/me",{ headers: authz({Accept:"application/json"})});
      ME = res.ok ? (await res.json()).user : null;
    }catch{ ME=null; }
    updateRoleBadge();
  }

  function updateRoleBadge(){
    const b = document.getElementById("roleBadge");
    b.textContent = ME ? ME.role : "Guest";
    const btnRole = document.getElementById("btnRole");
    btnRole.style.display = ME ? "inline-flex" : "none";
    btnRole.textContent = ME && ME.role==="Creator" ? "Switch to Consumer" : "Switch to Creator";
  }

  async function switchRole(){
    if(!ME) return alert("Please sign in first.");
    const target = ME.role==="Creator" ? "Consumer" : "Creator";
    const res = await fetch("/me/role",{ method:"POST", headers: authz({"Content-Type":"application/json"}), body: JSON.stringify({role:target}) });
    if(!res.ok){ return alert("Role change failed: "+(await res.text()).slice(0,200)); }
    await refreshMe(); gateUI();
  }

  function renderAuthUI(){
    const signed = !!(ID_TOKEN || localStorage.getItem("EDUTALK_ID_TOKEN"));
    document.getElementById("btnSignIn").style.display  = signed ? "none" : "inline-flex";
    document.getElementById("btnSignOut").style.display = signed ? "inline-flex" : "none";
    updateRoleBadge();
  }

  function gateUI(){
    const isCreator = !!(ME && ME.role==="Creator");
    document.getElementById("formWrap").style.display = isCreator ? "block" : "none";
    document.getElementById("gateMsg").style.display  = isCreator ? "none"  : "block";
  }

  // ===== Desktop upload to Azure Blob (via Container SAS) =====
  const containerSas = (document.querySelector('meta[name="blob-container-sas"]')?.content || '').trim();
  const blobArea = document.getElementById("blobArea");
  if (containerSas && /^https?:\/\//i.test(containerSas)) {
    blobArea.style.display = "block";
  }

  function parseContainerInfo(containerSasUrl){
    // Example: https://account.blob.core.windows.net/videos?<SAS>
    try{
      const u = new URL(containerSasUrl);
      const account = u.hostname.split('.')[0];
      const container = u.pathname.replace(/^\//,'').split('/')[0];
      const qs = u.search; // includes leading '?'
      const base = `https://${account}.blob.core.windows.net/${container}`;
      return { account, container, query: qs, base };
    }catch{
      return null;
    }
  }

  async function uploadToBlobWithSas(file){
    const info = parseContainerInfo(containerSas);
    if (!info) throw new Error("Invalid container SAS URL.");
    // We upload to: base + '/' + filename + SAS
    const safeName = file.name.replace(/[^\w.\- ]+/g,'_'); // rudimentary cleanup
    const putUrl = `${info.base}/${encodeURIComponent(safeName)}${info.query}`;
    const res = await fetch(putUrl, {
      method: "PUT",
      headers: {
        "x-ms-blob-type": "BlockBlob",
        "x-ms-version": "2021-12-02",
        "Content-Type": file.type || "application/octet-stream"
      },
      body: file
    });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`Blob upload failed: ${res.status} ${res.statusText} — ${txt.slice(0,180)}`);
    }
    // The public (read) URL (no SAS needed because container is Public: Blob)
    return `${info.base}/${encodeURIComponent(safeName)}`;
  }

  // ===== Save metadata to EduTalk (Creator only) =====
  async function submitForm(e){
    e.preventDefault();
    const status = document.getElementById("status");
    status.textContent = "";

    if(!ME || ME.role!=="Creator"){
      status.textContent = "You must be Creator to upload.";
      return;
    }
    const body = {
      title:       document.getElementById("title").value.trim(),
      publisher:   document.getElementById("publisher").value.trim(),
      producer:    document.getElementById("producer").value.trim(),
      genre:       document.getElementById("genre").value.trim(),
      age:         document.getElementById("age").value.trim(),
      playbackUrl: document.getElementById("playbackUrl").value.trim(),
      external:    true
    };
    if(!body.title || !body.playbackUrl){
      status.textContent = "Title and Playback URL are required.";
      return;
    }

    try{
      document.getElementById("btnSubmit").disabled = true;
      status.textContent = "Saving…";
      const res = await fetch("/videos",{
        method:"POST",
        headers: { ...authz({"Content-Type":"application/json"}) },
        body: JSON.stringify(body)
      });
      const txt = await res.text();
      if(!res.ok){
        status.textContent = `Save failed: ${res.status} ${res.statusText} — ${(txt||"").slice(0,180)}`;
        return;
      }
      status.textContent = "Saved ✓";
      // window.location.href = "/videos.html";
    }catch(e){
      status.textContent = "Save error: "+e.message;
    }finally{
      document.getElementById("btnSubmit").disabled = false;
    }
  }

  // ===== Bootstrap =====
  (async ()=>{
    renderAuthUI();
    if(ID_TOKEN) await refreshMe();
    gateUI();

    document.getElementById("btnSignIn").addEventListener("click", signIn);
    document.getElementById("btnSignOut").addEventListener("click", signOut);
    document.getElementById("btnRole").addEventListener("click", switchRole);
    document.getElementById("formWrap").addEventListener("submit", submitForm);

    if (blobArea.style.display !== "none") {
      const blobStatus = document.getElementById("blobStatus");
      document.getElementById("btnBlobUpload").addEventListener("click", async ()=>{
        const file = document.getElementById("filePick").files?.[0];
        if (!file) { blobStatus.textContent = "Choose a file first."; return; }
        try{
          blobStatus.textContent = "Uploading to Azure Blob…";
          const url = await uploadToBlobWithSas(file);
          // Fill playback URL with the public blob URL
          document.getElementById("playbackUrl").value = url;
          blobStatus.textContent = "Uploaded ✓";
        }catch(e){
          blobStatus.textContent = e.message;
        }
      });
    }
  })();
</script>
</body>
</html>
