<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EduTalk — Upload</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css?v=6" />
  <style>
    .row { margin: 8px 0 }
    .right { float: right }
    .muted { color: #9aa3b2; font-size: .9rem }
    .hint  { margin:6px 0 0; font-size:.85rem; color:#9aa3b2 }
    .tiny  { font-size:.8rem }
    .muted-sm { color:#9aa3b2; font-size:.85rem }
  </style>
</head>
<body>
  <header class="nav">
    <h1><a href="/" style="color:inherit;text-decoration:none">EduTalk VideoShare</a></h1>
    <nav>
      <a href="/videos.html">All Videos</a>
      <a href="/">Home</a>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <div class="row">
        <h2 style="display:inline">Upload a New Video</h2>
        <button id="setKeyBtn" class="btn right tiny" type="button" title="Store/clear the CREATOR_API_KEY used for uploads">Creator API key…</button>
      </div>

      <form id="uploadForm">
        <div class="row"><label>Title:<br>
          <input type="text" name="title" required></label></div>

        <div class="row"><label>Publisher:<br>
          <input type="text" name="publisher"></label></div>

        <div class="row"><label>Producer:<br>
          <input type="text" name="producer"></label></div>

        <div class="row"><label>Genre:<br>
          <input type="text" name="genre"></label></div>

        <div class="row"><label>Age Rating:<br>
          <input type="text" name="age" placeholder="e.g. G, PG, 13+, 18+"></label></div>

        <!-- Desktop file upload -->
        <div class="row">
          <label>Upload from Desktop:</label><br>
          <input type="file" id="fileInput" accept="video/*" />
          <button type="button" id="fileUploadBtn" class="btn">Upload Video File</button>
          <small id="fileStatus" class="muted-sm"></small>
        </div>

        <div class="row"><label>Playback URL:<br>
          <input type="url" name="playbackUrl"
                 placeholder="Azure Blob SAS URL (mp4/webm/ogg) or YouTube link"
                 required></label>
          <div id="urlHint" class="hint"></div>
        </div>

        <div class="row">
          <button type="submit" class="btn">Upload</button>
        </div>
      </form>

      <p id="msg" class="muted" style="margin-top:8px"></p>
    </section>
  </main>

  <footer class="footer">© EduTalk</footer>

  <script>
    // ===== Desktop file upload → Azure Blob (with SAS) =====
    // 1) Paste your Container SAS URL (from Azure Portal → Storage → Containers → videos → Shared access tokens)
    // Example format:
    // https://stvideosedutalk.blob.core.windows.net/videos?sp=rwc&st=...&se=...&sv=...&sr=c&sig=...
    const CONTAINER_SAS = "PASTE_YOUR_CONTAINER_SAS_URL_HERE";

    // 2) Build a blob URL for a new filename within that container
    function buildBlobUrl(filename) {
      const [base, query] = CONTAINER_SAS.split("?");
      return `${base.replace(/\/$/, "")}/${encodeURIComponent(filename)}?${query}`;
    }

    // 3) Upload handler
    async function uploadSelectedFile() {
      const fileEl = document.getElementById("fileInput");
      const statusEl = document.getElementById("fileStatus");
      const urlInput = document.querySelector('input[name="playbackUrl"]');

      const file = fileEl?.files?.[0];
      if (!file) { alert("Please choose a video file first."); return; }
      if (!CONTAINER_SAS || !CONTAINER_SAS.includes("?")) {
        alert("Container SAS URL is missing. Paste it at the top of this file.");
        return;
      }

      // Use a safe unique name to avoid clashes
      const safeName = file.name.replace(/[^\w.\-]+/g, "_");
      const blobName = `${Date.now()}_${safeName}`;
      const blobUrl = buildBlobUrl(blobName);

      try {
        statusEl.textContent = "Uploading…";
        const res = await fetch(blobUrl, {
          method: "PUT",
          headers: {
            "x-ms-blob-type": "BlockBlob"
          },
          body: file
        });

        if (!res.ok) {
          const txt = await res.text().catch(()=>"");
          throw new Error(`HTTP ${res.status} ${res.statusText} ${txt.slice(0,140)}`);
        }

        // If the container is public (Blob), you may use blobUrl.split("?")[0] as the playback URL
        urlInput.value = blobUrl;

        statusEl.textContent = "Uploaded ✓";
        alert("Upload complete. Playback URL field has been filled.");
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Upload failed";
        alert("Upload error: " + (err?.message || err));
      }
    }

    // Wire up the button
    document.getElementById("fileUploadBtn")?.addEventListener("click", uploadSelectedFile);
  </script>

  <script>
    // -------------- tiny helpers --------------
    const API_BASE = location.origin; // call the same site we're on
    const LS_KEY   = 'edutalk_creator_api_key';

    const $ = sel => document.querySelector(sel);

    function isYouTube(u='') {
      try {
        const x = new URL(u);
        return x.hostname.includes('youtube.com') || x.hostname.includes('youtu.be');
      } catch { return false; }
    }
    function isVideoFile(u='') {
      return /\.(mp4|webm|ogg)(\?|#|$)/i.test(u);
    }

    // -------------- key management --------------
    function getApiKey() {
      return localStorage.getItem(LS_KEY) || '';
    }
    function setApiKeyInteractive() {
      const current = getApiKey();
      const v = prompt(
        current
          ? 'Update your CREATOR_API_KEY (leave blank to remove it):'
          : 'Enter your CREATOR_API_KEY (from Azure App Settings):',
        current
      );
      if (v === null) return;        // cancelled
      if (v.trim() === '') {
        localStorage.removeItem(LS_KEY);
        alert('Key removed. (Uploads will work only if the server does not require a key.)');
      } else {
        localStorage.setItem(LS_KEY, v.trim());
        alert('Key saved in this browser.');
      }
      reflectKeyState();
    }
    function reflectKeyState() {
      const has = !!getApiKey();
      $('#setKeyBtn').textContent = has ? 'Creator API key ✓' : 'Creator API key…';
      $('#setKeyBtn').classList.toggle('muted', !has);
    }

    // -------------- form behaviour --------------
    $('#setKeyBtn').addEventListener('click', setApiKeyInteractive);
    reflectKeyState();

    // real-time hint for the URL
    $('input[name="playbackUrl"]').addEventListener('input', e => {
      const v = e.target.value.trim();
      const hint = isYouTube(v)
        ? 'Detected YouTube link — it will be embedded with a YouTube player.'
        : isVideoFile(v)
          ? 'Detected direct video file — it will play with the built-in HTML5 player.'
          : 'Paste an Azure Blob SAS URL (mp4/webm/ogg) or a YouTube link.';
      $('#urlHint').textContent = hint;
    });

    $('#uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const msg  = $('#msg');

      const payload = {
        title:       form.title.value.trim(),
        publisher:   form.publisher.value.trim(),
        producer:    form.producer.value.trim(),
        genre:       form.genre.value.trim(),
        age:         form.age.value.trim(),
        playbackUrl: form.playbackUrl.value.trim()
      };

      if (!payload.title || !payload.playbackUrl) {
        msg.textContent = '❌ Title and Playback URL are required.';
        return;
      }

      try {
        const headers = { 'Content-Type': 'application/json' };
        const key = getApiKey();
        if (key) headers['x-api-key'] = key; // only sent if set

        msg.textContent = 'Uploading…';
        const res  = await fetch(`${API_BASE}/videos`, {
          method: 'POST',
          headers,
          body: JSON.stringify(payload)
        });
        const text = await res.text();

        if (!res.ok) {
          msg.textContent = `❌ Upload failed: ${res.status} ${res.statusText} — ${text.slice(0,200)}`;
          return;
        }

        msg.textContent = '✅ Video saved. Redirecting to the list…';
        setTimeout(() => location.href = '/videos.html', 900);
      } catch (err) {
        console.error(err);
        msg.textContent = '⚠️ Network error: ' + err.message;
      }
    });
  </script>
</body>
</html>
